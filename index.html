<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>C# → Mermaid クラス図 自動生成（Visualizer）</title>
  <script type="module">
    import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs";
    mermaid.initialize({ startOnLoad: false });
    window.mermaid = mermaid; // グローバル関数から呼べるようにする
  </script>
  <style>
    body { font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background: #f4f4f9; color: #333; }
    h1 { font-size: 1.5rem; margin-bottom: 10px; }
    p { font-size: 0.9rem; color: #666; margin-bottom: 20px; }
    
    .container { display: flex; gap: 20px; flex-direction: column; }
    
    textarea { 
      width: 100%; height: 150px; padding: 10px; 
      font-family: Consolas, monospace; border: 1px solid #ccc; border-radius: 6px;
      resize: vertical;
    }
    
    .controls { margin: 10px 0; }
    button { 
      padding: 10px 20px; font-size: 1rem; cursor: pointer; 
      background: #007bff; color: white; border: none; border-radius: 6px; 
      transition: background 0.2s;
    }
    button:hover { background: #0056b3; }
    button.reset { background: #dc3545; margin-left: 10px; }
    button.reset:hover { background: #a71d2a; }

    /* 図の表示エリア */
    #diagramContainer { 
      background: #fff; padding: 20px; border-radius: 12px; 
      box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
      min-height: 200px; overflow: auto;
    }
    
    #hiddenCodes { display:none; }
  </style>
</head>
<body>

  <h1>C# → Mermaid クラス図 ビジュアライザー</h1>
  <p>C#のコードを貼り付けて「解析して追加」を押すと、クラス図が成長していきます。</p>

  <div class="container">
    <div>
      <textarea id="codeInput" placeholder="// ここに public class ... を含むコードを貼り付け"></textarea>
      <div class="controls">
        <button onclick="processAndAdd()">解析して追加</button>
        <button onclick="resetDiagram()" class="reset">リセット</button>
      </div>
    </div>

    <div id="diagramContainer"></div>
  </div>

  <div id="hiddenCodes"></div>

<script type="module">
  // モジュール外でも使えるように関数をwindowに紐付け
  import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs";
  
  // グラフ定義を保持する変数（初期値）
  let currentGraphDefinition = "classDiagram\n";

  window.processAndAdd = async function() {
    const input = document.getElementById('codeInput');
    const code = input.value;
    if(!code.trim()) return;

    // 1. 投下コードを保存（非表示領域へ）
    document.getElementById('hiddenCodes').innerText += "\n\n" + code;

    // 2. 解析処理
    let newDef = "";
    
    // public class 取得
    // Regex: public (static) class ClassName
    const classMatches = [...code.matchAll(/public\s+(?:static\s+)?class\s+(\w+)/g)];
    const classNames = classMatches.map(m => m[1]);

    // クラス定義を追加
    classNames.forEach(c => {
      // 既に定義済みでなければ追加（重複防止）
      if(!currentGraphDefinition.includes(`class ${c}`)) {
        newDef += `  class ${c}\n`;
      }
    });

    // メソッド & 関連の取得
    // Regex: public (static) RetType MethodName (Args)
    const methodMatches = [...code.matchAll(/public\s+(?:static\s+)?([\w<>\[\]]+)\s+(\w+)\s*\(([^)]*)\)/g)];

    methodMatches.forEach(m => {
      const returnType = m[1];
      const methodName = m[2];
      const args = m[3].replace(/,/g, ' '); // 引数のカンマはMermaidで誤作動しやすいので置換
      
      // 所属クラスを特定
      const owner = findOwnerClass(code, m.index);

      if(owner) {
        // メソッド定義: Class : +Method(args) Type
        newDef += `  ${owner} : +${methodName}(${args}) ${returnType}\n`;

        // 戻り値の型が、今回追加されたクラス、または既存の図に含まれているクラスなら線を引く
        const simpleType = returnType.replace(/[<>\[\]]/g, ''); // List<T>などを除去して単一型名へ
        
        // 戻り値がクラス名として認識できる、かつ自分自身への参照でなければ矢印を追加
        if (simpleType !== owner && (classNames.includes(simpleType) || currentGraphDefinition.includes(`class ${simpleType}`))) {
           // 重複線の防止ロジックは簡易的に省略（必要なら追加）
           newDef += `  ${owner} --> ${simpleType} : returns\n`;
        }
      }
    });

    // 3. 定義を結合
    currentGraphDefinition += newDef;

    // 4. 再描画実行
    await renderDiagram();

    // 入力欄をクリア
    input.value = "";
  };

  window.resetDiagram = async function() {
    currentGraphDefinition = "classDiagram\n";
    document.getElementById('hiddenCodes').innerText = "";
    await renderDiagram();
  };

  // 描画関数：ここがポイント
  async function renderDiagram() {
    const container = document.getElementById('diagramContainer');
    
    // 既存のSVGを削除して、新しいテキスト用プレースホルダーを作る
    container.innerHTML = `<pre class="mermaid" id="mermaidTarget">${currentGraphDefinition}</pre>`;
    
    // Mermaid v10 APIを使って描画
    await mermaid.run({
      nodes: [document.querySelector('#mermaidTarget')]
    });
  }

  function findOwnerClass(code, index) {
    const before = code.substring(0, index);
    // 直近の class 定義を探す
    const matches = [...before.matchAll(/public\s+(?:static\s+)?class\s+(\w+)/g)];
    const match = matches.pop();
    return match ? match[1] : null;
  }
</script>
</body>
</html>
