<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>C# → Mermaid クラス図（左右2ペイン）</title>
  <script type="module">
    import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs";
    mermaid.initialize({ startOnLoad: false });
  </script>
  <style>
    body { font-family: sans-serif; margin: 0; background: #f0f0f0; }
    #container { display: flex; height: 100vh; }
    #leftPane { width: 50%; padding: 20px; box-sizing: border-box; overflow: auto; background: #fafafa; }
    #rightPane { width: 50%; padding: 20px; box-sizing: border-box; overflow: auto; background: #ffffff; border-left: 2px solid #ccc; }
    textarea { width: 100%; height: 250px; font-family: monospace; padding: 10px; }
    button { padding: 10px 16px; margin-right: 6px; font-size: 1rem; cursor: pointer; }
    pre.mermaid { white-space: pre-wrap; }
    #hiddenCodes { display:none; }
  </style>
</head>
<body>
<div id="container">
  <div id="leftPane">
    <h2>コード入力</h2>
    <textarea id="codeInput" placeholder="ここにC#コードを貼り付け"></textarea>
    <br />
    <button onclick="processAndAdd()">解析して追加</button>
    <button onclick="resetDiagram()">リセット</button>
    <div id="hiddenCodes"></div>
  </div>

  <div id="rightPane">
    <h2>生成された Mermaid 図</h2>
    <pre class="mermaid" id="mermaidCode">classDiagram
</pre>
  </div>
</div>

<script>
function processAndAdd(){
  var code = document.getElementById('codeInput').value;
  if(!code.trim()) return;

  document.getElementById('hiddenCodes').innerText += "\n\n" + code;

  var mermaidPre = document.getElementById('mermaidCode');
  var mer = mermaidPre.innerText;

  var classRegex = /public\\s+(?:static\\s+)?class\\s+(\\w+)/g;
  var methodRegex = /public\\s+(?:static\\s+)?([\\w<>]+)\\s+(\\w+)\\s*\\(([^)]*)\\)/g;

  var classes = [];
  var match;
  while ((match = classRegex.exec(code)) !== null) {
    classes.push(match[1]);
  }

  classes.forEach(function(c){
    if(mer.indexOf("class " + c) === -1){
      mer += "  class " + c + "\n";
    }
  });

  while ((match = methodRegex.exec(code)) !== null) {
    var returnType = match[1];
    var methodName = match[2];
    var args = match[3];
    var owner = findOwnerClass(code, match.index);

    if(owner){
      mer += "  " + owner + " : +" + methodName + "(" + args + ") " + returnType + "\n";
    }

    var ref = returnType.match(/\\w+/);
    if(ref && classes.indexOf(ref[0]) !== -1){
      mer += "  " + owner + " --> " + ref[0] + " : returns\n";
    }
  }

  mermaidPre.innerText = mer;
  mermaid.init();
  document.getElementById('codeInput').value = "";
}

function resetDiagram(){
  document.getElementById('mermaidCode').innerText = "classDiagram\n";
  document.getElementById('hiddenCodes').innerText = "";
  mermaid.init();
}

function findOwnerClass(code, index) {
  var before = code.substring(0, index);
  var regex = /public\\s+(?:static\\s+)?class\\s+(\\w+)/g;
  var match;
  var last = null;
  while ((match = regex.exec(before)) !== null) {
    last = match[1];
  }
  return last;
}
</script>
</body>
</html>
